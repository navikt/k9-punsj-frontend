name: Deploy til preprod

on: [workflow_dispatch]

env:
    DOCKER_IMAGE: ghcr.io/${{ github.repository }}

jobs:
  lint:
    uses: ./.github/workflows/lint.yml
    secrets:
      READER_TOKEN: ${{ secrets.READER_TOKEN }}
  test:
    uses: ./.github/workflows/test.yml
    secrets:
      READER_TOKEN: ${{ secrets.READER_TOKEN }}
  test-cypress:
    uses: ./.github/workflows/cypress-tester.yml
    secrets:
      READER_TOKEN: ${{ secrets.READER_TOKEN }}
  build:
    uses: ./.github/workflows/build.yml
    secrets:
      READER_TOKEN: ${{ secrets.READER_TOKEN }}
  deploy-dev:
      name: Deploye til DEV
      runs-on: ubuntu-latest
      needs: [lint, test, test-cypress, build]
      steps:
          - uses: actions/download-artifact@v3
            with:
              name: dist
              path: ./dist
          - uses: docker/login-action@v1.14.1
            with:
                registry: ghcr.io
                username: ${{ github.REPOSITORY_OWNER }}
                password: ${{ secrets.GITHUB_TOKEN }}

          - name: Sett tag for docker image
            run: echo "TAG=$(date "+%Y.%m.%d")-$(git rev-parse --short HEAD)" >> $GITHUB_ENV

          - name: Bygge & laste opp Docker image
            run: |
                docker build --pull --tag ${DOCKER_IMAGE}:${TAG} --tag ${DOCKER_IMAGE}:latest .
                docker push ${DOCKER_IMAGE} --all-tags

          - name: Sett image for nais deploy
            run: echo "IMAGE=${DOCKER_IMAGE}:${TAG}" >> $GITHUB_ENV

          - name: Deploye til dev
            uses: nais/deploy/actions/deploy@v1
            env:
                APIKEY: ${{ secrets.NAIS_DEPLOY_APIKEY }}
                CLUSTER: dev-fss
                RESOURCE: nais/frontend/k9-punsj-frontend.yml
                VARS: nais/frontend/dev.json

name: Build and deploy to prod
on:
    push:
        paths-ignore:
            - '**.md'
            - '.gitignore'
            - 'LICENCE'
            - 'CODEOWNERS'
            - 'nais/proxy/*'
        branches:
            - master

env:
    DOCKER_IMAGE: ghcr.io/${{ github.repository }}

jobs:
    lint:
        uses: ./.github/workflows/lint.yml
        secrets:
            READER_TOKEN: ${{ secrets.READER_TOKEN }}
    test:
        uses: ./.github/workflows/test.yml
        secrets:
            READER_TOKEN: ${{ secrets.READER_TOKEN }}
    test-cypress:
        uses: ./.github/workflows/cypress-tester.yml
        secrets:
            READER_TOKEN: ${{ secrets.READER_TOKEN }}
    build:
        uses: ./.github/workflows/build.yml
        secrets:
            READER_TOKEN: ${{ secrets.READER_TOKEN }}
    deploy:
        name: Deploye til PROD
        runs-on: ubuntu-latest
        permissions:
            packages: write
        needs: [lint, test, test-cypress, build]
        outputs:
            image: ${{ steps.docker-push.outputs.image }}
        steps:
            - name: Hente kode
              uses: actions/checkout@v4

            - name: Setup .yarnrc.yml
              run: |
                  yarn config set npmScopes.navikt.npmRegistryServer "https://npm.pkg.github.com"
                  yarn config set npmScopes.navikt.npmAlwaysAuth true
                  yarn config set npmScopes.navikt.npmAuthToken $NPM_AUTH_TOKEN
              env:
                  NPM_AUTH_TOKEN: ${{ secrets.READER_TOKEN }}

            - name: Sette opp Node
              uses: actions/setup-node@v4
              with:
                  node-version: 18.x
                  registry-url: https://npm.pkg.github.com/
                  scope: '@navikt'

            - uses: actions/download-artifact@v3
              with:
                  name: dist
                  path: ./dist

            - name: Installere moduler
              run: yarn install --immutable
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.READER_TOKEN }}

            - name: Opprett release med Sentry
              run: yarn sentry-release
              env:
                  SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}


            - uses: docker/login-action@v2.2.0
              with:
                  registry: ghcr.io
                  username: ${{ github.REPOSITORY_OWNER }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Sett tag for docker image
              run: echo "TAG=$(date "+%Y.%m.%d")-$(git rev-parse --short HEAD)" >> $GITHUB_ENV

            - name: Bygge & laste opp Docker image
              run: |
                  docker build --pull --tag ${DOCKER_IMAGE}:${TAG} --tag ${DOCKER_IMAGE}:latest .
                  docker push ${DOCKER_IMAGE} --all-tags

            - name: Sett image for nais deploy
              run: echo "IMAGE=${DOCKER_IMAGE}:${TAG}" >> $GITHUB_ENV

            - name: Deploye til prod
              uses: nais/deploy/actions/deploy@v1
              env:
                  APIKEY: ${{ secrets.NAIS_DEPLOY_APIKEY }}
                  CLUSTER: prod-fss
                  RESOURCE: nais/frontend/k9-punsj-frontend.yml
                  VARS: nais/frontend/prod.json
            - name: Set image output
              id: docker-push
              run: echo "IMAGE=$DOCKER_IMAGE:$TAG" >> $GITHUB_OUTPUT
    trivy:
        needs: [deploy]
        uses: navikt/sif-gha-workflows/.github/workflows/trivy-ghcr.yml@main
        permissions:
            contents: write
            security-events: write
            actions: read
        secrets: inherit
        with:
            image: ${{ needs.deploy.outputs.image }}
